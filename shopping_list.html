<!DOCTYPE html>
<html>
<head>
<title>Shopping List by TigerhawkT3</title>
<meta name='viewport' content='width=device-width'>
</head>
<body>
<div id='list' align='center'></div><br />
<div align='center'>
<button style='float:left; margin-left: 9vw;'
    type='button' id='add_button' class='export' title='append new item to list' onclick='add_item()'>Add item</button>
<button style='float:right; margin-right: 9vw;'
    type='button' id='update_button' class='export' onclick='update_url()'>Update URL</button>
</div>
<style>
button.list {
    vertical-align: top;
    font-size: calc(10px + 2vw);
    width: 9vw;
    height: 9vw;
    max-height: 12vh;
    max-width: 12vh;
    min-height: 6vw;
    min-width: 6vw;
}
input.list {
    vertical-align: top;
    width: 9vw;
    height: 9vw;
    max-height: 12vh;
    max-width: 12vh;
    min-height: 6vw;
    min-width: 6vw;
}
button.export {
    height: 9vw;
    min-height: 6vw;
    max-height: 12vh;
    font-size: calc(10px + 1vw);
}
textarea.list {
    vertical-align: top;
    box-sizing: border-box;
    width: 70vw;
    height: 9vw;
    font-size: calc(10px + 2vw);
    max-height: 12vh;
    min-height: 6vw;
}
</style>
<script>
let list = document.getElementById('list');
let add_button = document.getElementById('add_button');
let update_button = document.getElementById('update_button');
let select_message = 'select this item';
let lifted = null;
function new_item() { // create a new item
    newElement = document.createElement('div');
    newElement.style = 'padding: 3px;'
    newElement.innerHTML = "<input class='list' title='choose a color' type='color' value='#FFFFFF'>\n" +
        "<button class='list' title='" + select_message + "' onclick='interact(this)'>&gt;</button>\n" +
        "<textarea class='list' placeholder='Enter item...'></textarea>\n";
    return newElement;
}
function insert(e) { // insert a new item above element e's parent
    newElement = new_item();
    list.insertBefore(newElement, e.parentNode);
    newElement.children[2].focus();
}
function append() { // append a new item to the end of the list
    newElement = new_item();
    list.appendChild(newElement);
    newElement.children[2].focus();
}
function add_item() { // handle the button to add/insert
    if (!lifted) append();
    else {
        insert(lifted);
        clear_lift();
    }
}
function remove(e) { // remove an item
    list.removeChild(e.parentNode);
}
function interact(e) { // interact with an item
    if (!lifted) { // choose an item to interact with
        lifted = e;
        e.innerText = '...';
        e.title = 'cross off, or remove if empty; click a different ">" to move this there';
        add_button.title = 'insert new item above selected item';
        update_button.innerText = 'Split item...';
        update_button.title = 'split this into multiple items by newline or highlighted substring';
        return;
    }
    if (e === lifted) {
        if (e.nextElementSibling.value != '') // non-empty, toggle strikethrough
            toggle_strike(lifted.nextElementSibling);
        else remove(e); // empty, remove item
    }
    else list.insertBefore(lifted.parentNode, e.parentNode); // move item
    clear_lift();
}
function toggle_strike(e) {
    if (e.style['text-decoration'] === 'line-through')
        e.style['text-decoration'] = 'none';
    else e.style['text-decoration'] = 'line-through';
}
function update_url() { // create URL and navigate there, or split an item
    if (!lifted) {
        let items = Array.from(list.getElementsByTagName('div'));
        let result = location.origin + location.pathname + '?' + items.map(
            e => (e.children[2].style['text-decoration']==='line-through' ? '1' : '0') +
                 '.' +
                 e.children[0].value.slice(1) +
                 '_' +
                 encodeURIComponent(e.children[2].value)
            ).join('&');
        window.location.href = result;
    }
    else {
        let ele = lifted.nextElementSibling;
        let content = ele.value;
        let substring = content.slice(ele.selectionStart, ele.selectionEnd) || '\n';
        let items = content.split(substring);
        let last = items.pop();
        for (let item of items) {
            let e = new_item();
            e.children[0].value = lifted.previousElementSibling.value;
            e.children[2].value = item;
            if (lifted.nextElementSibling.style['text-decoration'] === 'line-through') toggle_strike(e.children[2]);
            list.insertBefore(newElement, lifted.parentNode);
        }
        ele.value = last;
        clear_lift();
    }
}
function clear_lift() { // reset buttons and tooltips after putting down a lifted item
    lifted.innerText = '>';
    lifted.title = select_message;
    lifted = null;
    add_button.title = 'append new item to list';
    update_button.innerText = 'Update URL';
    update_button.title = '';
}
if (location.search === '') append(); // empty query string, just make one node
else { // non-empty query string, import nodes
    let items = location.search.slice(1).split('&');
    for (let item of items) {
        let e = new_item();
        let content = decodeURIComponent(item);
        e.children[0].value = '#' + content.slice(2, 8)
        e.children[2].value = content.slice(9);
        if (content.slice(0, 1) === '1') toggle_strike(e.children[2]);
        list.appendChild(e);
    }
}
</script>
</body>
</html>