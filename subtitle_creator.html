<html>
<head><title>TigerhawkT3's Timed Text</title></head>
<body>
<style>
video::cue {
    font-size: 150%
}
div.list {
    position: absolute;
    right: 5px;
    width: 44%;
    height: 98%;
}
td > textarea.time {
    height: 1.5em;
    width: 8em;
    vertical-align: bottom;
    resize: none;
}
td > textarea.text {
    min-height: 1.5em;
    vertical-align: bottom;
    width:100%;
    resize: vertical;
}
td > input {
    min-height: 1.5em;
    vertical-align: top;
}
table > tr.show {
    display: auto;
}
table > tr.hide {
    display: none;
}
</style>
<div class='list'>
 <table align='center'><tr>
 <td><input type='number' id='page' min='1' max='99999' step='1' value='1' title='Page number' onchange='pagego()'></textarea></td>
 <td>/</td>
 <td id='pagecount'>1</td>
 </tr></table>
 <table style='border-collapse:collapse;' border='1' id='list' width='100%'></table></div>
<div style='text-align:right; width: 55%'>
<video id='vid' style='max-width: 100%;' preload="metadata" controls></video><br />
 <input type='file' id='chooser' accept='video/*' />
 <input type='number' placeholder='step' id='step_size' style='width: 4em;' min='0' title='Step size in seconds' />
 <input type='button' value='<' onclick='jump_seconds(-1)' title='Seek backward by step size' />
 <input type='button' value='>' onclick='jump_seconds(1)' title='Seek forward by step size' />
 <input type='button' id='loop_button' value='Loop in-out' onclick='loop_inout()' title='Loop from in to out points' />
<br />
<textarea id="source" style='height: 100px; width: 100%; max-width: 800px;'></textarea><br />
<input type='button' id='inbutton' value='00:00:00.000' onclick='mark_in()' title='(Set new) in point' />-->
<input type='button' id='outbutton' value='00:00:00.000' onclick='mark_out()' title='(Set new) out point' />
<br />
<input type='button' value='Apply' onclick='load_sub()' title='Apply saved cues as subtitles to current video' />
<input type='button' value='Export' onclick='export_string()' title='Export saved cues in WebVTT format into the text area' />
<input type='button' value='Import' onclick='import_vtt()' title='Import a WebVTT file from the text area into a list of cues' />
<input type='button' value='Sort' onclick='sort()' title='Sort the list of cues' />
<br />
</div>
<script>

txt = document.getElementById('source');
vid = document.getElementById('vid');
info = document.getElementById('info');
loop_button = document.getElementById('loop_button');
step_size = document.getElementById('step_size');
list = document.getElementById('list');
inbutton = document.getElementById('inbutton');
outbutton = document.getElementById('outbutton');
pagecount = document.getElementById('pagecount');
track = document.createElement("track");
track.label = "Main";
vid.appendChild(track);
vid.textTracks[0].mode = 'showing';
PAGE_LENGTH = 10;
point_in = 0;
point_out = 0;
looping = null;
list.appendChild(make_row(secondsToStamp(point_in), secondsToStamp(point_out), ''));

function pagego() {
    let destination = Math.floor(page.valueAsNumber);
    if (list.children.length <= PAGE_LENGTH || destination < 1 || destination > total_pages()) {
        destination = Math.max(1, Math.min(destination, total_pages()));
        page.value = destination;
    }
    for (let row of Array.from(list.getElementsByClassName('show'))) row.className = 'hide';
    for (let i = (destination-1)*10; i < Math.min((destination-1)*10+10, list.children.length); ++i) list.children[i].className = 'show';
    pagecount.innerText = total_pages();
}
function wheel(e) {
    e.preventDefault();
    let current = Math.floor(page.valueAsNumber);
    page.valueAsNumber = Math.min(total_pages(), Math.max(current + (e.deltaY>0?1:-1), 1));
    pagego();
}
function total_pages() {
    return Math.ceil(list.children.length/PAGE_LENGTH);
}
function make_row(i, o, t) {
    let row = document.createElement('tr');
    row.className = 'show';
    row.innerHTML = '<td><input type="button" value="-" title="Remove this cue" onclick="remove(this)"/></td>' +
        '<td><input type="button" value="+" title="Add a cue above this" onclick="insert(this)"/></td>' +
        '<td><input type="button" value="^" title="Move this cue up" onclick="up(this)"/></td>' +
        '<td><input type="button" value="i" title="Set from in point" onclick="new_point(this, \'in\')"/></td>' +
        '<td><textarea class="time" rows=1 title="Cue start time">'+i+'</textarea></td>' +
        '<td><input type="button" title="Set from out point"value="o" onclick="new_point(this, \'out\')" /></td>' +
        '<td><textarea class="time" rows=1 title="Cue end time">'+o+'</textarea></td>' +
        '<td><textarea class="text" rows=2 cols=60 title="Cue text">'+t+'</textarea></td>';
    return row;
}
function remove(e) {
    if (list.children.length === 1) return;
    list.removeChild(e.parentNode.parentNode);
    pagego();
}
function insert(e) {
    list.insertBefore(make_row(secondsToStamp(point_in), secondsToStamp(point_out), ''), e.parentNode.parentNode);
    pagego();
}
function up(e) {
    list.insertBefore(e.parentNode.parentNode, e.parentNode.parentNode.previousElementSibling);
    pagego();
}
function assemble() {
    return 'WEBVTT\n\n' + Array.from(list.children).map(x => 
        `${x.children[4].children[0].value} --> ` +
        `${x.children[6].children[0].value}\n` + 
        `${x.children[7].children[0].value}`).join('\n\n');
}
function new_point(e, which) {
    e.parentNode.nextElementSibling.children[0].value = secondsToStamp(which==='in'?point_in:point_out)
}
function jump_seconds(direction) {
    vid.currentTime += direction * step_size.valueAsNumber || 0;
}
function loop_inout() {
    if (looping === null) {
        loop_schedule();
        loop_button.value = 'Looping...';
    }
    else {
        clearTimeout(looping);
        looping = null;
        loop_button.value = 'Loop in-out';
    }
}
function loop_schedule() {
    vid.currentTime = point_in;
    looping = setTimeout(loop_schedule, Math.abs((point_out-point_in)*1000));
}
function secondsToStamp(num) {
        let h = `${Math.floor(num/3600)}`.padStart(2, '0');
        let remainder = num%3600;
        let m = `${Math.floor(remainder/60)}`.padStart(2, '0');
        let s = `${Math.floor(remainder%60)}`.padStart(2, '0');
        let ms = num.toFixed(3).split('.')[1];
        return `${h}:${m}:${s}.${ms}`;
}
function load_sub(event) {
    track.src = URL.createObjectURL(new Blob([assemble()]));
}
function mark_in() {
    point_in = vid.currentTime;
    inbutton.value = secondsToStamp(point_in);
    return point_in;
}
function mark_out() {
    point_out = vid.currentTime;
    outbutton.value = secondsToStamp(point_out);
    return point_out;
}
function export_string() {
    txt.value = assemble();
}
function import_vtt() {
    cues = txt.value.slice(txt.value.indexOf('\n')+1).trim().split('\n\n');
    list.innerHTML = '';
    for (let cue of cues) {
        idx = cue.indexOf('\n');
        let [start, end] = cue.slice(0, idx).trim().split(' --> ').map(x => x.split(':'));
        start = 3600*(start[0]) + 60*(start[1]) + parseFloat(start[2]);
        end = 3600*(end[0]) + 60*(end[1]) + parseFloat(end[2]);
        text = cue.slice(idx+1);
        row = make_row(secondsToStamp(start), secondsToStamp(end), text);
        if (list.children.length >= PAGE_LENGTH) row.className = 'hide';
        list.appendChild(row);
    }
    pagecount.innerText = Math.ceil(list.children.length/PAGE_LENGTH);
    load_sub();
    txt.value = '';
}
function sort() {
    let temp = Array.from(list.children);
    temp.sort((a, b) => a.children[4].children[0].value.localeCompare(b.children[4].children[0].value));
    list.innerHTML = '';
    for (let e of temp) list.appendChild(e);
}
function play_file(event) {
    let file = this.files[0];
    if (!file) return;
    if (vid.canPlayType(file.type) === 'no') return;
    vid.src = URL.createObjectURL(file);
}
document.getElementById('chooser').addEventListener('change', play_file, false);
list.addEventListener('wheel', wheel, true);
</script>
</body> 
</html>